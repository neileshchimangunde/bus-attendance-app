<script>
const API = "https://script.google.com/macros/s/AKfycbzo5F-peHvI_EJVdKsT71OyNYJNrf9i6BrsbpIGlazGtFLEypjEl9vNUoRafJ9ufuhc/exec"; // CHANGE to your Web App URL

let state = { token:null, role:null, bus_no:null, email:null };
const qs = (s) => document.querySelector(s);

async function api(path, payload) {
  const res = await fetch(API, {
    method: "POST",
    body: JSON.stringify({ path, ...payload })
  });
  return res.json();
}

/* ==== LOGIN HANDLER ==== */
qs("#btnLogin").addEventListener("click", async () => {
  qs("#loginErr").textContent = "";
  const email = qs("#email").value.trim();
  const password = qs("#password").value.trim();

  if (!email || !password) {
    qs("#loginErr").textContent = "Enter email and password";
    return;
  }

  const r = await api("login", { email, password });

  if (!r.ok) {
    qs("#loginErr").textContent = r.error || "Login failed";
    return;
  }

  state = { token:r.token, role:r.role, bus_no:r.bus_no, email };
  qs("#login").classList.add("hidden");
  qs("#main").classList.remove("hidden");

  qs("#welcome").textContent = `Welcome, ${email}`;
  qs("#sub").textContent = `Role: ${r.role} | Bus: ${r.bus_no}`;

  if (r.role === "admin") loadDashboard();
  else loadBusView();
});

/* ==== LOGOUT ==== */
qs("#btnLogout").addEventListener("click", () => {
  location.reload();
});

/* ==== BUS LADY VIEW ==== */
async function loadBusView() {
  const r = await api("getStudents", { token: state.token });
  if (!r.ok) return alert("Auth error");

  let html = `<h3 class="mt-3 font-semibold">Mark Attendance</h3>`;
  r.students.forEach(s => {
    html += `
    <div class="flex justify-between bg-white p-2 rounded border mt-2">
      <span>${s.student_name}</span>
      <select class="border px-2" onchange="mark('${s.student_id}', this.value)">
        <option value="">-</option>
        <option value="P">Present</option>
        <option value="A">Absent</option>
      </select>
    </div>`;
  });

  html += `<button class="mt-4 bg-green-600 text-white p-2 rounded" onclick="submit()">Submit</button>`;
  qs("#studentList").innerHTML = html;
}

let marks = {};
function mark(id, v){ marks[id] = v; }

async function submit() {
  const today = new Date().toISOString().split("T")[0];
  const records = Object.entries(marks).map(([student_id, status]) => ({
    date: today, session: "AM", student_id, status
  }));

  const r = await api("submitAttendance", { token: state.token, records });
  alert(r.ok ? "Saved!" : "Error saving!");
}

/* ==== ADMIN DASHBOARD ==== */
async function loadDashboard() {
  const r = await api("getDashboard", { token: state.token });
  if (!r.ok) return alert("Auth error");

  let html = `<h3 class="font-semibold mt-3">Attendance Summary</h3>`;
  for (let k in r.dashboard) {
    const d = r.dashboard[k];
    html += `<div class="bg-white border p-2 rounded mt-2">${k} â†’ ${d.present}/${d.total} present</div>`;
  }
  qs("#dashboard").innerHTML = html;
}
</script>
